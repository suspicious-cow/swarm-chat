# Swarm Chat

Real-time deliberation platform powered by **Conversational Swarm Intelligence** (CSI). Large groups deliberate better when broken into small, interconnected subgroups rather than one giant conversation. Swarm Chat splits participants into "ThinkTanks" of ~5 people and uses LLM-powered **Surrogate Agents** to cross-pollinate ideas between them in real time.

![Lobby](screenshots/01-lobby-initial.png)

## How It Works

1. A **facilitator** creates a session with a deliberation topic
2. **Participants** join using a 6-character code and get auto-assigned to subgroups
3. People **chat in real time** within their small group via WebSocket
4. The **Conversational Matching Engine (CME)** runs on a background timer:
   - Extracts ideas from each subgroup's messages using an LLM
   - Identifies ideas that haven't been discussed across groups
   - Dispatches **Surrogate Agents** that naturally introduce cross-group insights
   - Dispatches **Contributor Agents** that ask probing questions and raise new perspectives
   - Tracks **convergence** across subgroups as ideas spread
5. When the session completes, participants see a **Mission Debrief** with the collective summary, ideas, convergence score, and full message history

```
  ThinkTank 1          ThinkTank 2          ThinkTank 3
  +----------+         +----------+         +----------+
  | Alice    |         | Dave     |         | Grace    |
  | Bob      |<------->| Eve      |<------->| Hank     |
  | Carol    | surrogate| Frank    | surrogate| Ivy      |
  +----------+  agents  +----------+  agents  +----------+
        ^                                          |
        +------------------------------------------+
                    CME cross-pollinates ideas
```

## Tech Stack

| Layer | Technology |
|-------|------------|
| Backend | Python 3.12, FastAPI, SQLAlchemy (async), PostgreSQL, Redis pub/sub |
| Frontend | React 19, TypeScript, Zustand, Vite, Motion |
| LLM | Provider-agnostic — Gemini, OpenAI, Anthropic, Mistral, or any OpenAI-compatible API |
| Auth | Cookie-based sessions, bcrypt passwords, TOTP MFA, invite codes |
| Infrastructure | Docker Compose (dev + prod), Nginx (prod) |
| Testing | pytest (backend), Vitest (frontend), Playwright (E2E) |

## Quick Start

### Prerequisites

- [Docker](https://docs.docker.com/get-docker/) and Docker Compose
- An API key for at least one LLM provider (Gemini, OpenAI, Anthropic, Mistral, DeepSeek, or a local model via Ollama)

### Setup

```bash
git clone https://github.com/suspicious-cow/swarm-chat.git
cd swarm-chat
cp .env.example .env
```

Edit `.env` and add your `LLM_API_KEY` at minimum. Then:

```bash
docker compose up --build
```

| Service | URL |
|---------|-----|
| Frontend | http://localhost:3000 |
| Backend API | http://localhost:58432 |
| API Docs (Swagger) | http://localhost:58432/docs |

The first user to register automatically becomes the server admin. Subsequent users need an invite code generated by the admin.

## Screenshots

| Lobby | Waiting Room | Chat | Visualizer |
|-------|-------------|------|------------|
| ![Lobby](screenshots/01-lobby-initial.png) | ![Waiting](screenshots/04-waiting-admin.png) | ![Chat](screenshots/07-chat-messages.png) | ![Visualizer](screenshots/08-visualizer-view.png) |

## Features

### Authentication & Access Control
- **Account registration** with invite codes (first user auto-promoted to admin)
- **TOTP MFA** — optional two-factor authentication via authenticator apps
- **Server admin** manages invite codes (create, list, revoke) and session controls
- **Session admin** — the session creator can start/stop deliberation and generate summaries

### Deliberation Engine
- **Surrogate Agents** — relay ideas between subgroups as natural chat messages
- **Contributor Agents** — ask probing questions, play devil's advocate, raise new perspectives
- **Idea Extraction** — LLM-powered taxonomy phase identifies ideas with sentiment analysis
- **Convergence Tracking** — measures how ideas spread across subgroups in real time
- **Challenge Prioritization** — surrogates prioritize under-discussed and challenged ideas

### Session Results
- **Deliberative Summary** — LLM-generated collective report written as the group's own assessment
- **Mission Debrief** view — convergence score, summary, ideas with sentiment bars, message history by subgroup, crew manifest
- **Auto-transition** — participants automatically navigate to results when a session completes
- **Persistent artifacts** — summary and convergence score saved to the database for later review

### UI & Theming
- **Retro-futurism CRT aesthetic** — phosphor glow, scan lines, instrument panel cards
- **Light/dark theme toggle** — CSS custom properties with full theme support
- **Real-time updates** — WebSocket-driven chat, typing indicators, convergence updates
- **Deliberation Map** — force-directed graph visualization of subgroups, ideas, and cross-pollination

### Testing & Development
- **Bot users** — LLM-powered simulated participants for manual testing
- **152 backend tests** (unit + integration) with mocked LLM and Redis
- **38 frontend tests** (store + component) via Vitest
- **10 E2E tests** with Playwright screenshots

## LLM Configuration

Swap providers by changing environment variables — no code changes required.

| Provider | `LLM_PROVIDER` | `LLM_BASE_URL` | Example `LLM_MODEL` |
|----------|----------------|-----------------|----------------------|
| Gemini | `gemini` | *(not needed)* | `gemini-3-flash-preview` |
| OpenAI | `openai` | *(not needed)* | `gpt-5.2` |
| Anthropic | `anthropic` | *(not needed)* | `claude-haiku-4-5-20251001` |
| Mistral | `mistral` | *(not needed)* | `mistral-medium-3-1-25-08` |
| DeepSeek | `openai-compatible` | `https://api.deepseek.com` | `deepseek-chat` |
| Ollama (local) | `openai-compatible` | `http://host.docker.internal:11434/v1` | `llama3` |

**Example** — switch from Gemini to DeepSeek:

```env
LLM_PROVIDER=openai-compatible
LLM_BASE_URL=https://api.deepseek.com
LLM_API_KEY=sk-your-deepseek-key
LLM_MODEL=deepseek-chat
```

Then restart the backend: `docker compose restart backend`

## Environment Variables

All configuration is done via `.env` (see `.env.example`).

### Database & Infrastructure

| Variable | Default | Description |
|----------|---------|-------------|
| `DATABASE_URL` | `postgresql+asyncpg://swarmchat:...@postgres:5432/swarmchat` | PostgreSQL connection string |
| `POSTGRES_USER` | `swarmchat` | PostgreSQL user |
| `POSTGRES_PASSWORD` | `swarmchat_dev_password` | PostgreSQL password |
| `POSTGRES_DB` | `swarmchat` | PostgreSQL database name |
| `REDIS_URL` | `redis://redis:6379/0` | Redis connection string |
| `DB_POOL_SIZE` | `20` | SQLAlchemy connection pool size |
| `DB_MAX_OVERFLOW` | `40` | Max overflow connections beyond pool size |

### LLM

| Variable | Default | Description |
|----------|---------|-------------|
| `LLM_PROVIDER` | `gemini` | Provider: `gemini`, `openai`, `anthropic`, `mistral`, `openai-compatible` |
| `LLM_API_KEY` | *(empty)* | API key for your chosen provider |
| `LLM_MODEL` | `gemini-3-flash-preview` | Model identifier |
| `LLM_BASE_URL` | *(empty)* | Base URL (only needed for `openai-compatible`) |

### Engine Tuning

| Variable | Default | Description |
|----------|---------|-------------|
| `SUBGROUP_SIZE` | `5` | Target number of members per ThinkTank |
| `CME_INTERVAL_SECONDS` | `20` | How often (seconds) the CME scans for new ideas |
| `SURROGATE_INTERVAL_SECONDS` | `30` | Minimum interval between surrogate messages per subgroup |
| `CME_CONCURRENCY` | `10` | Max concurrent subgroup processing tasks |

### Application

| Variable | Default | Description |
|----------|---------|-------------|
| `SECRET_KEY` | `dev-secret-key-change-in-production` | JWT signing key |
| `BACKEND_CORS_ORIGINS` | `http://localhost:3000,http://localhost:80` | Allowed CORS origins |

## Architecture

### Core Engine: The CME Loop

The Conversational Matching Engine runs as a background async task every `CME_INTERVAL_SECONDS`. It uses a Redis distributed lock for multi-worker safety.

```
+-----------------------------------------------------+
|                   CME Cycle                          |
|                                                      |
|  1. Acquire distributed lock (Redis)                 |
|                                                      |
|  For each active session:                            |
|    For each subgroup (concurrent, semaphore):        |
|                                                      |
|    1. TAXONOMY PHASE                                 |
|       Fetch last 20 messages                         |
|       --> LLM extracts ideas + sentiment             |
|       --> Save as Idea records (deduplicated)        |
|                                                      |
|    2. CROSS-POLLINATION PHASE                        |
|       Find ideas NOT in this subgroup                |
|       Select up to 3 most relevant                   |
|       --> LLM crafts natural surrogate message       |
|       --> Save as Message (type: surrogate)          |
|       --> Broadcast via Redis pub/sub + WebSocket    |
|                                                      |
|    3. CONTRIBUTOR PHASE                              |
|       --> LLM generates probing questions            |
|       --> Save as Message (type: contributor)        |
|       --> Broadcast via Redis pub/sub + WebSocket    |
|                                                      |
|  3. Release lock                                     |
+-----------------------------------------------------+
```

### Message Types

| Type | Source | Badge | Description |
|------|--------|-------|-------------|
| `human` | Real participant | *(name)* | Normal chat message |
| `surrogate` | CME engine | **AI RELAY** | Relays ideas from other subgroups |
| `contributor` | CME engine | **AI** | Asks probing questions, raises new perspectives |

### Subgroup Partitioning

- **On session start**: Users assigned round-robin to subgroups. Small remainders are merged (e.g., 11 users / size 5 = groups of 6+5, not 5+5+1).
- **Late joins**: Assigned to the smallest existing subgroup, or a new subgroup is created if all are at capacity.
- **Labels**: Auto-generated as "ThinkTank 1", "ThinkTank 2", etc.

## Project Structure

```
swarm-chat/
├── backend/
│   ├── app/
│   │   ├── main.py              # FastAPI app, lifespan, CORS, routers
│   │   ├── config.py            # Pydantic Settings (all env vars)
│   │   ├── database.py          # SQLAlchemy async engine & session
│   │   ├── models/              # ORM models
│   │   │   ├── account.py       #   Account (username, password, MFA, admin)
│   │   │   ├── session.py       #   Session (waiting -> active -> completed)
│   │   │   ├── user.py          #   User (display_name, is_admin, subgroup)
│   │   │   ├── subgroup.py      #   Subgroup (label, session)
│   │   │   ├── message.py       #   Message (human/surrogate/contributor)
│   │   │   ├── idea.py          #   Idea (summary, sentiment, counts)
│   │   │   └── invite_code.py   #   InviteCode (code, max_uses, expiry)
│   │   ├── engine/              # Core deliberation logic
│   │   │   ├── cme.py           #   Background CME loop (Redis-locked)
│   │   │   ├── taxonomy.py      #   Idea extraction, dedup, convergence
│   │   │   ├── surrogate.py     #   Surrogate Agent message crafting
│   │   │   ├── contributor.py   #   Contributor Agent (probing questions)
│   │   │   └── partitioner.py   #   Subgroup assignment (round-robin)
│   │   ├── services/
│   │   │   ├── llm.py           #   Provider-agnostic LLM client (5 backends)
│   │   │   └── redis.py         #   Redis pub/sub messaging
│   │   ├── routers/             # REST API endpoints
│   │   │   ├── auth.py          #   Register, login, logout, me
│   │   │   ├── mfa.py           #   TOTP setup and verification
│   │   │   ├── sessions.py      #   Session CRUD, start/stop, results
│   │   │   ├── users.py         #   Join, get user, messages
│   │   │   ├── admin.py         #   Status dashboard, summary generation
│   │   │   ├── dashboard.py     #   Session listing for logged-in users
│   │   │   └── invite_codes.py  #   Invite code CRUD (admin only)
│   │   ├── schemas/             # Pydantic request/response schemas
│   │   └── websocket/           # WebSocket connection manager & handlers
│   ├── alembic/                 # Database migrations
│   │   └── versions/            #   Migration scripts (001-003)
│   ├── tests/                   # pytest test suite (152 tests)
│   │   ├── conftest.py          #   Test DB, mock LLM/Redis, test client
│   │   ├── unit/                #   9 unit test modules
│   │   └── integration/         #   8 integration test modules
│   ├── requirements.txt
│   ├── requirements-test.txt
│   └── Dockerfile
├── frontend/
│   ├── src/
│   │   ├── App.tsx              # View router
│   │   ├── components/          # React UI components (21 components)
│   │   │   ├── Layout.tsx       #   App shell with sidebar
│   │   │   ├── Sidebar.tsx      #   Navigation sidebar
│   │   │   ├── LoginView.tsx    #   Login form
│   │   │   ├── MfaChallengeView.tsx # TOTP verification
│   │   │   ├── HomeView.tsx     #   Dashboard with session list
│   │   │   ├── NewSessionView.tsx   # Create session form
│   │   │   ├── JoinSessionView.tsx  # Join by code
│   │   │   ├── SettingsView.tsx #   Account & MFA settings
│   │   │   ├── WaitingView.tsx  #   Waiting room with join code
│   │   │   ├── ChatRoom.tsx     #   Chat interface with admin panel
│   │   │   ├── ChatInput.tsx    #   Message input + Send
│   │   │   ├── MessageBubble.tsx#   Styled message with agent badges
│   │   │   ├── AdminPanel.tsx   #   Start/Stop/Summary/Bot controls
│   │   │   ├── Visualizer.tsx   #   Deliberation Map (force graph)
│   │   │   ├── SubgroupNode.tsx #   Circular subgroup indicator
│   │   │   ├── ParticipantsView.tsx # Subgroup member list
│   │   │   ├── ResultsView.tsx  #   Mission Debrief (post-session)
│   │   │   ├── InviteCodeManager.tsx # Admin invite code UI
│   │   │   ├── MfaSettingsPanel.tsx  # TOTP enable/disable
│   │   │   ├── ToastContainer.tsx    # Toast notifications
│   │   │   └── SwarmLogo.tsx    #   Animated logo component
│   │   ├── stores/
│   │   │   ├── deliberationStore.ts  # Zustand session state
│   │   │   ├── authStore.ts     #   Zustand auth state
│   │   │   └── toastStore.ts    #   Zustand toast notifications
│   │   ├── hooks/
│   │   │   ├── useDeliberation.ts    # Session polling & view transitions
│   │   │   └── useWebSocket.ts       # WebSocket connections & messaging
│   │   ├── styles/              # Design system
│   │   │   ├── constants.ts     #   Colors, fonts, layout tokens
│   │   │   ├── retro.ts         #   Reusable retro-futurism styles
│   │   │   └── motion.ts        #   Animation variants
│   │   └── types/index.ts       # TypeScript interfaces
│   ├── src/__tests__/           # Vitest test suite (38 tests)
│   ├── vitest.config.ts
│   ├── vite.config.ts
│   ├── nginx.conf               # Production reverse proxy
│   └── Dockerfile
├── e2e/                         # Playwright E2E tests (10 tests)
│   ├── tests/
│   │   ├── lobby.spec.ts        #   Lobby screenshots (3 tests)
│   │   └── session-lifecycle.spec.ts  # Full journey (7 tests)
│   ├── playwright.config.ts
│   ├── global-setup.ts          #   Cleans screenshots/ before run
│   └── Dockerfile
├── screenshots/                 # Generated by E2E tests (gitignored)
├── docker-compose.yml           # Development environment
├── docker-compose.prod.yml      # Production overrides
└── .env.example                 # Environment variable template
```

## API Reference

### Authentication

| Method | Endpoint | Description |
|--------|----------|-------------|
| `POST` | `/api/auth/register` | Create account `{username, password, display_name, invite_code?}` |
| `POST` | `/api/auth/login` | Login `{username, password}` — returns token or MFA challenge |
| `POST` | `/api/auth/logout` | Clear auth cookies |
| `GET` | `/api/auth/me` | Get current account |

### MFA

| Method | Endpoint | Description |
|--------|----------|-------------|
| `POST` | `/api/auth/mfa/setup` | Generate TOTP secret and provisioning URI |
| `POST` | `/api/auth/mfa/verify` | Verify TOTP code and enable MFA |
| `POST` | `/api/auth/mfa/verify-login` | Complete login with TOTP code |

### Sessions

| Method | Endpoint | Description |
|--------|----------|-------------|
| `POST` | `/api/sessions` | Create a session `{title, subgroup_size}` |
| `GET` | `/api/sessions/{id}` | Get session details (includes user/subgroup counts) |
| `GET` | `/api/sessions/join/{code}` | Look up session by join code |
| `POST` | `/api/sessions/{id}/start` | Start deliberation (creates subgroups) |
| `POST` | `/api/sessions/{id}/stop` | End deliberation (persists convergence score) |
| `GET` | `/api/sessions/{id}/subgroups` | List subgroups with members |
| `GET` | `/api/sessions/{id}/ideas` | List extracted ideas |
| `GET` | `/api/sessions/{id}/results` | Get full results (summary, ideas, messages, subgroups) |

### Users

| Method | Endpoint | Description |
|--------|----------|-------------|
| `POST` | `/api/users` | Join session `{join_code, display_name}` |
| `GET` | `/api/users/{id}` | Get user details |
| `GET` | `/api/users/{id}/messages` | Get messages in user's subgroup |

### Admin

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/api/admin/{session_id}/status` | Session status with subgroup breakdown |
| `POST` | `/api/admin/{session_id}/summary` | Generate LLM-powered deliberation summary |

### Dashboard

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/api/dashboard/sessions` | List sessions for logged-in account |

### Invite Codes

| Method | Endpoint | Description |
|--------|----------|-------------|
| `POST` | `/api/admin/invite-codes` | Create invite code (admin only) |
| `GET` | `/api/admin/invite-codes` | List all invite codes (admin only) |
| `DELETE` | `/api/admin/invite-codes/{id}` | Deactivate an invite code |

### Health

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/api/health` | `{"status": "ok"}` |

### WebSocket

| Endpoint | Purpose |
|----------|---------|
| `ws://.../ws/chat/{user_id}/{subgroup_id}` | Real-time subgroup chat |
| `ws://.../ws/session/{user_id}/{session_id}` | Session-wide events (start, stop, joins) |

**Events received by clients:**
- `chat:new_message` — New message in subgroup (human, surrogate, or contributor)
- `chat:surrogate_typing` — Surrogate Agent is about to speak
- `session:started` — Deliberation started, includes subgroup assignments
- `session:completed` — Deliberation ended, triggers auto-navigation to results
- `session:user_joined` — New participant joined
- `session:convergence` — Updated convergence score for the session

**Events sent by clients:**
```json
{"event": "chat:message", "data": {"content": "Your message text"}}
```

## Testing

All tests run inside Docker containers.

### Backend (152 tests)

```bash
docker compose exec backend python -m pytest tests/ -v
```

- **Unit tests** (9 modules): LLM service dispatch, partitioner logic, taxonomy extraction, surrogate/contributor message crafting, CME cycle orchestration, WebSocket manager, auth utilities, MFA verification
- **Integration tests** (8 modules): Full API endpoint coverage (auth, sessions, users, admin, dashboard, MFA, invite codes, health)
- Uses in-memory SQLite with mocked LLM and Redis

### Frontend (38 tests)

```bash
docker compose exec frontend npm test
```

- **Store tests**: All Zustand actions and state transitions
- **Component tests**: ChatRoom, ChatInput, MessageBubble, AdminPanel, Visualizer

### E2E (10 tests, 10 screenshots)

```bash
docker compose --profile e2e run --rm e2e
```

Runs headless Chromium inside a Playwright container. Generates numbered screenshots in `screenshots/`:

| # | Screenshot | What it captures |
|---|------------|------------------|
| 01 | `lobby-initial.png` | Fresh lobby load |
| 02 | `lobby-create-filled.png` | Create form filled in |
| 03 | `lobby-session-created.png` | Session created with join code |
| 04 | `waiting-admin.png` | Admin in waiting room |
| 05 | `waiting-users-joined.png` | Multiple users joined |
| 06 | `chat-room-empty.png` | Chat room after session start |
| 07 | `chat-messages.png` | Messages sent in chat |
| 08 | `visualizer-view.png` | Deliberation Map visualization |
| 09 | `session-completed.png` | Session stopped |
| 10 | `summary-generated.png` | Summary generated |

## Production Deployment

```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up --build -d
```

This builds optimized images:
- **Backend**: Gunicorn with 4 Uvicorn workers
- **Frontend**: Static build served by Nginx on port 80
- Nginx proxies `/api/` and `/ws/` to the backend

Make sure to set strong values for `SECRET_KEY`, `POSTGRES_PASSWORD`, and `LLM_API_KEY` in production.

## Database Migrations

Migrations are managed with Alembic (async PostgreSQL):

```bash
# Apply all migrations
docker compose exec backend python -m alembic upgrade head

# Check current revision
docker compose exec backend python -m alembic current

# Generate a new migration
docker compose exec backend python -m alembic revision --autogenerate -m "description"
```

Current migrations:
1. `001_initial` — Core tables (accounts, sessions, users, subgroups, messages, ideas)
2. `002_add_admin_invite_totp` — Server admin flag, invite codes, TOTP secrets
3. `003_add_session_results_columns` — Summary and convergence persistence

## License

MIT
